<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi-stage Link Authenticator — Красивый интерфейс</title>
  <meta name="description" content="Генератор уникальных ссылок с многоступенчатыми проверками и генерацией ключей. Поддержка GitHub Pages (single-file)." />
  <style>
    /* --- Modern minimal UI --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root{--bg:#f4f7fb;--card:#ffffff;--muted:#6b7280;--accent:#6c5ce7;--accent-2:#3b82f6;--danger:#ef4444;--success:#10b981;--glass:rgba(255,255,255,0.6);--max:980px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#0f172a;background:linear-gradient(180deg,var(--bg),#eef2ff);display:flex;align-items:flex-start;justify-content:center;padding:28px}
    .container{width:100%;max-width:var(--max);}
    .hero{display:flex;gap:18px;align-items:center;margin-bottom:18px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:0 6px 22px rgba(60,50,100,0.12)}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(15,23,42,0.06);}
    .section-title{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}

    label{display:block;font-size:13px;margin-bottom:6px;color:#111827}
    input[type="text"], input[type="url"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;background:#fbfdff}
    .row{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #eef2ff}
    .btn.warn{background:var(--danger)}
    .btn.small{padding:6px 8px;font-size:13px}

    .stages{display:flex;flex-direction:column;gap:10px}
    .stage-row{display:flex;gap:10px;align-items:center;border:1px solid #eef2ff;padding:10px;border-radius:10px}
    .stage-meta{flex:1}
    .stage-actions{display:flex;gap:8px}
    .stage-url{font-size:13px;color:#0f172a;opacity:0.9;word-break:break-all}

    .generated{background:#f8fafc;padding:10px;border-radius:8px;border:1px dashed #eef2ff;font-size:13px}
    .small{font-size:13px}
    .muted{color:var(--muted)}

    .progress{height:12px;background:#e6eef8;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;transition:width 360ms cubic-bezier(.2,.9,.3,1)}

    footer{margin-top:12px;color:var(--muted);font-size:13px}

    .key-box{font-family:monospace;background:#0b122033;padding:10px;border-radius:8px;color:#0b1220}

    .top-actions{display:flex;gap:8px;align-items:center}

    .info-row{display:flex;gap:8px;align-items:center}

    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <div class="logo">MA</div>
      <div>
        <h1>Multi-stage Link Authenticator</h1>
        <p class="lead">Красивый single-file сайт для создания уникальных ссылок с 1–3 этапами, прогрессом и ключами — готов к размещению на GitHub Pages.</p>
      </div>
    </div>

    <div class="grid">
      <!-- Left: main admin / exec area -->
      <div class="card" id="mainCard">
        <!-- Admin view -->
        <div id="adminView">
          <div class="section-title">
            <strong>Режим настройки (админ)</strong>
            <span class="muted">— создайте конфигурацию и получите ссылку</span>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
            <div style="flex:1">
              <label>Имя проекта (опционально)</label>
              <input id="projectName" type="text" placeholder="Например: Тест IQ" />
            </div>
            <div style="width:140px">
              <label>Этапы</label>
              <select id="numStages"><option>1</option><option selected>2</option><option>3</option></select>
            </div>
          </div>

          <div id="stagesContainer" class="stages"></div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
            <button id="generateBtn" class="btn">Сгенерировать ссылку</button>
            <button id="previewBtn" class="btn ghost">Предпросмотр</button>
            <button id="clearBtn" class="btn ghost">Очистить</button>
            <div style="flex:1"></div>
            <button id="copyLinkBtn" class="btn small ghost">Копировать</button>
            <button id="openLinkBtn" class="btn small ghost">Открыть</button>
          </div>

          <div style="margin-top:12px">
            <label>Ссылка</label>
            <div id="linkArea" class="generated">—</div>
          </div>

          <div style="margin-top:12px">
            <label>Превью конфигурации</label>
            <div id="previewArea" class="generated small muted">—</div>
          </div>
        </div>

        <!-- Execution view -->
        <div id="execView" class="hidden">
          <div class="section-title">
            <strong>Режим выполнения</strong>
            <span class="muted">— следуйте этапам и получите ключ</span>
          </div>

          <div class="info-row" style="justify-content:space-between">
            <div class="muted small" id="cfgInfo">—</div>
            <div style="display:flex;gap:8px">
              <button id="resetProgressBtn" class="btn small ghost">Сбросить прогресс</button>
              <button id="copyKeyBtn" class="btn small ghost hidden">Копировать ключ</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Этапы</label>
            <div id="execStages" class="stages"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <label>Ключ</label>
              <div id="keyArea" class="generated key-box">—</div>
            </div>
            <div style="width:220px">
              <label>Статус ключа</label>
              <div id="keyStatus" class="generated small muted">—</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Ссылка с конфигурацией</label>
            <div id="execLink" class="generated small">—</div>
          </div>
        </div>

      </div>

      <!-- Right: help / legend -->
      <div class="card">
        <div>
          <strong>Инструкция</strong>
          <p class="muted small">1) Настройте 1–3 этапа → 2) Сгенерируйте ссылку → 3) Разошлите пользователям. Они откроют ссылку, выполнят этапы и получат ключ (формат AUTH-XXXX-XXXX-XXXX-XXXX, срок 12 часов).</p>

          <div style="margin-top:12px">
            <strong>Формат ссылки</strong>
            <div class="generated small">https://yourname.github.io/repo/#config=[base64]&progress=1,2&key=...&keyCreated=...</div>
          </div>

          <div style="margin-top:12px">
            <strong>Замечания</strong>
            <ul class="muted small">
              <li>Всё работает на клиенте (статический сайт). Для надёжности ключи нужно подписывать на сервере.</li>
              <li>URL этапов проходят базовую валидацию (http/https).</li>
              <li>Прогресс сохраняется в hash + localStorage.</li>
            </ul>
          </div>

          <div style="margin-top:12px">
            <strong>Готово для GitHub Pages</strong>
            <p class="muted small">Положите файл <code>index.html</code> в репозиторий и включите Pages — страница будет доступна по адресу <code>https://username.github.io/repo/</code>.</p>
          </div>

        </div>
      </div>
    </div>

    <footer style="margin-top:12px">
      <div class="muted small">Created — Multi-stage Link Authenticator · single-file · key life 12 hours</div>
    </footer>
  </div>

<script>
/* --- Utility functions --- */
function base64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) { return String.fromCharCode('0x' + p1); }));
}
function base64DecodeUnicode(str) {
  try {
    return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
  } catch(e) { return null; }
}
function parseHash() {
  const hash = location.hash.replace(/^#/, '');
  if (!hash) return {};
  return hash.split('&').reduce((acc, part) => {
    const [k,v] = part.split('=');
    acc[k] = v===undefined?null:decodeURIComponent(v);
    return acc;
  }, {});
}
function buildHash(obj) {
  const parts = [];
  for (const k in obj) {
    if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') parts.push(k + '=' + encodeURIComponent(obj[k]));
  }
  return parts.join('&');
}
function encodeConfig(cfg) { return base64EncodeUnicode(JSON.stringify(cfg)); }
function decodeConfig(b64) { try { const j = base64DecodeUnicode(b64); return JSON.parse(j); } catch(e){ return null; } }
function isValidHttpUrl(s) { try { const u = new URL(s); return u.protocol==='http:'||u.protocol==='https:' } catch(e){ return false } }
function copyToClipboard(text){
  navigator.clipboard?.writeText(text).catch(()=> { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); });
}

/* --- DOM refs --- */
const numStages = document.getElementById('numStages');
const stagesContainer = document.getElementById('stagesContainer');
const generateBtn = document.getElementById('generateBtn');
const linkArea = document.getElementById('linkArea');
const copyLinkBtn = document.getElementById('copyLinkBtn');
const openLinkBtn = document.getElementById('openLinkBtn');
const previewBtn = document.getElementById('previewBtn');
const clearBtn = document.getElementById('clearBtn');
const previewArea = document.getElementById('previewArea');
const projectName = document.getElementById('projectName');

const adminView = document.getElementById('adminView');
const execView = document.getElementById('execView');

const cfgInfo = document.getElementById('cfgInfo');
const execStages = document.getElementById('execStages');
const resetProgressBtn = document.getElementById('resetProgressBtn');
const keyArea = document.getElementById('keyArea');
const keyStatus = document.getElementById('keyStatus');
const copyKeyBtn = document.getElementById('copyKeyBtn');
const execLink = document.getElementById('execLink');

/* --- Stage inputs render --- */
function renderStageInputs() {
  stagesContainer.innerHTML = '';
  const n = parseInt(numStages.value,10);
  for (let i=1;i<=n;i++){
    const div = document.createElement('div');
    div.className = 'stage-row';
    div.innerHTML = `
      <div class="stage-meta">
        <label>URL этапа ${i}</label>
        <input type="url" id="stageUrl_${i}" placeholder="https://example.com/task${i}">
        <div style="height:6px"></div>
        <label>Описание (опционально)</label>
        <input type="text" id="stageDesc_${i}" placeholder="Короткое описание">
      </div>
      <div style="width:120px;display:flex;flex-direction:column;gap:8px">
        <div style="font-size:12px;color:var(--muted);text-align:center">ID: ${i}</div>
        <button class="btn ghost small" data-test="${i}" title="Проверить URL">Проверить</button>
      </div>
    `;
    stagesContainer.appendChild(div);
    div.querySelector('button[data-test]').addEventListener('click', ()=>{
      const u = document.getElementById('stageUrl_'+i).value.trim();
      if (isValidHttpUrl(u)) alert('URL валиден: ' + u);
      else alert('URL неверный: ' + (u||'(пустой)'));
    });
  }
}
numStages.addEventListener('change', renderStageInputs);
renderStageInputs();

/* Read config from inputs */
function readConfigFromInputs() {
  const n = parseInt(numStages.value,10);
  const stages = [];
  for (let i=1;i<=n;i++){
    const url = document.getElementById('stageUrl_'+i).value.trim();
    const desc = document.getElementById('stageDesc_'+i).value.trim();
    stages.push({id:i, url, description: desc || undefined});
  }
  return { version: "1.0", project: projectName.value.trim() || undefined, stages, created: new Date().toISOString() };
}

/* Generate link */
generateBtn.addEventListener('click', ()=>{
  const cfg = readConfigFromInputs();
  for (const s of cfg.stages) {
    if (!isValidHttpUrl(s.url)) { alert('Ошибка: некорректный URL: ' + (s.url||'(пустой)')); return; }
  }
  const b64 = encodeConfig(cfg);
  const base = location.origin + location.pathname;
  const link = `${base}#config=${b64}`;
  linkArea.textContent = link;
  previewArea.textContent = JSON.stringify(cfg, null, 2);
  copyToClipboard(link);
  alert('Ссылка с конфигурацией сгенерирована и скопирована в буфер обмена.');
});

/* Copy & open link */
copyLinkBtn.addEventListener('click', ()=> {
  const txt = linkArea.textContent.trim();
  if (txt && txt !== '—') { copyToClipboard(txt); alert('Ссылка скопирована'); }
});
openLinkBtn.addEventListener('click', ()=> {
  const txt = linkArea.textContent.trim();
  if (txt && txt !== '—') window.open(txt,'_blank');
});

/* Clear inputs */
clearBtn.addEventListener('click', ()=> {
  if (!confirm('Удалить все значения полей?')) return;
  projectName.value='';
  for (let i=1;i<=3;i++){
    const a=document.getElementById('stageUrl_'+i), b=document.getElementById('stageDesc_'+i);
    if (a) a.value='';
    if (b) b.value='';
  }
  linkArea.textContent='—';
  previewArea.textContent='—';
});

/* Preview mode: set hash and switch to exec view */
previewBtn.addEventListener('click', ()=>{
  const cfg = readConfigFromInputs();
  for (const s of cfg.stages) { if (!isValidHttpUrl(s.url)) { alert('Некорректный URL: ' + (s.url||'(пустой)')); return; } }
  const b64 = encodeConfig(cfg);
  location.hash = 'config=' + b64;
  checkUrlMode();
});

/* Execution mode UI */
function showExecutionMode(cfg, urlState) {
  adminView.classList.add('hidden');
  execView.classList.remove('hidden');

  execLink.textContent = location.origin + location.pathname + '#config=' + encodeConfig(cfg);
  cfgInfo.textContent = `Конфигурация: ${cfg.project||'(без имени)'} · создана: ${cfg.created} · этапов: ${cfg.stages.length}`;

  // progress: from hash else localStorage
  let progress = [];
  if (urlState && urlState.progress) progress = urlState.progress.split(',').filter(Boolean).map(x=>parseInt(x,10));
  else {
    const ls = localStorage.getItem('auth_progress_' + encodeConfig(cfg));
    if (ls) progress = ls.split(',').filter(Boolean).map(x=>parseInt(x,10));
  }

  renderExecStages(cfg.stages, progress);

  // key if present
  if (urlState && urlState.key) {
    keyArea.textContent = urlState.key;
    copyKeyBtn.classList.remove('hidden');
    copyKeyBtn.onclick = ()=> { copyToClipboard(urlState.key); alert('Ключ скопирован'); };
    if (urlState.keyCreated) {
      const created = new Date(decodeURIComponent(urlState.keyCreated));
      checkKeyValidity(urlState.key, created);
    }
  } else {
    keyArea.textContent = '—';
    copyKeyBtn.classList.add('hidden');
    keyStatus.textContent = '—';
  }

  // reset progress handler
  resetProgressBtn.onclick = ()=> {
    if (!confirm('Сбросить прогресс?')) return;
    const h = parseHash();
    delete h.progress; delete h.key; delete h.keyCreated;
    location.hash = buildHash(h);
    localStorage.removeItem('auth_progress_' + encodeConfig(cfg));
    checkUrlMode();
  };
}

/* Render exec stages */
function renderExecStages(stages, progress) {
  execStages.innerHTML = '';
  for (const s of stages) {
    const done = progress.includes(s.id);
    const div = document.createElement('div');
    div.className = 'stage-row';
    div.innerHTML = `
      <div class="stage-meta">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <strong>Этап ${s.id}</strong>
            <div class="muted small">${s.description||''}</div>
          </div>
          <div class="muted small">Ссылка: <span style="font-family:monospace;font-size:12px">${s.url}</span></div>
        </div>
      </div>
      <div style="width:160px;display:flex;flex-direction:column;gap:8px" class="stage-actions">
        <button class="btn small ghost" data-open="${s.id}">Перейти</button>
        <button class="btn small ${done?''+' ghost':''}" data-toggle="${s.id}">${done? 'Выполнено' : 'Отметить'}</button>
      </div>
    `;
    execStages.appendChild(div);
    div.querySelector('[data-open]').addEventListener('click', ()=> window.open(s.url,'_blank'));
    div.querySelector('[data-toggle]').addEventListener('click', async (e)=> {
      // update progress
      const h = parseHash();
      let prog = [];
      if (h.progress) prog = h.progress.split(',').filter(Boolean).map(x=>parseInt(x,10));
      else {
        const ls = localStorage.getItem('auth_progress_' + encodeConfig({version:"1.0",stages:stages,created:document.querySelector('#cfgInfo')?.textContent||new Date().toISOString()}));
        if (ls) prog = ls.split(',').filter(Boolean).map(x=>parseInt(x,10));
      }
      if (prog.includes(s.id)) prog = prog.filter(x=>x!==s.id); else prog.push(s.id);
      // save to localStorage and hash
      const cfgB64 = encodeConfig({version:"1.0",stages:stages,created:document.querySelector('#cfgInfo')?.textContent||new Date().toISOString()});
      localStorage.setItem('auth_progress_' + cfgB64, prog.join(','));
      const newHash = Object.assign({}, h, {config: cfgB64, progress: prog.join(',')});
      location.hash = buildHash(newHash);

      // rerender
      renderExecStages(stages, prog);

      // if all done => generate key
      if (prog.length === stages.length) {
        const keyObj = await generateKeyForCompletion(stages, prog);
        const keyStr = keyObj.key;
        const created = keyObj.created.toISOString();
        const h2 = parseHash();
        h2.config = encodeConfig({version:"1.0",stages:stages,created:document.querySelector('#cfgInfo')?.textContent||new Date().toISOString()});
        h2.progress = prog.join(',');
        h2.key = keyStr;
        h2.keyCreated = encodeURIComponent(created);
        location.hash = buildHash(h2);
        keyArea.textContent = keyStr;
        copyKeyBtn.classList.remove('hidden');
        copyKeyBtn.onclick = ()=> { copyToClipboard(keyStr); alert('Ключ скопирован'); };
        checkKeyValidity(keyStr, new Date(created));
      }
    });
  }
}

/* Key gen using SHA-256 */
async function generateKeyForCompletion(stages, progress) {
  const cfg = {version:"1.0",stages:stages,created:new Date().toISOString()};
  const payload = JSON.stringify(cfg) + '|' + progress.join(',') + '|' + new Date().toISOString();
  const enc = new TextEncoder().encode(payload);
  const hashBuf = await crypto.subtle.digest('SHA-256', enc);
  const hashArray = Array.from(new Uint8Array(hashBuf));
  const hex = hashArray.map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
  const short = hex.slice(0,16);
  const formatted = 'AUTH-' + short.match(/.{1,4}/g).join('-');
  return { key: formatted, created: new Date() };
}

/* Check key validity (12 hours) */
function checkKeyValidity(key, createdDate) {
  if (!key || !createdDate) { keyStatus.textContent = '—'; return; }
  const now = new Date();
  const ageMs = now - createdDate;
  const hours = ageMs / (1000*60*60);
  if (hours >= 12) {
    keyStatus.innerHTML = '<span style="color:var(--danger)">Ключ просрочен</span>';
    copyKeyBtn.classList.add('hidden');
  } else {
    const remain = 12 - hours;
    keyStatus.innerHTML = '<span style="color:var(--success)">Ключ валиден — осталось ' + remain.toFixed(2) + ' ч</span>';
    copyKeyBtn.classList.remove('hidden');
  }
}

/* Mode detection */
function hasConfigInUrl() { const h=parseHash(); return !!h.config; }
function checkUrlMode() {
  const h = parseHash();
  if (h.config) {
    const cfg = decodeConfig(h.config);
    if (!cfg) { alert('Ошибка декодирования конфига в URL'); adminView.classList.remove('hidden'); execView.classList.add('hidden'); return; }
    execView.dataset.created = cfg.created;
    showExecutionMode(cfg, h);
  } else {
    adminView.classList.remove('hidden'); execView.classList.add('hidden');
  }
}

/* On load */
window.addEventListener('load', ()=> {
  checkUrlMode();
});

/* Reactivity: update preview when inputs change */
function updatePreview() {
  try {
    const cfg = readConfigFromInputs();
    previewArea.textContent = JSON.stringify(cfg, null, 2);
  } catch(e){ previewArea.textContent = '—'; }
}
projectName.addEventListener('input', updatePreview);
stagesContainer.addEventListener('input', updatePreview);
numStages.addEventListener('change', updatePreview);

/* Also update preview on any input change (delegated) */
document.addEventListener('input', updatePreview);

/* Monitor hash changes */
window.addEventListener('hashchange', checkUrlMode);
</script>
</body>
</html>
