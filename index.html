<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advanced Client Protection — Stages</title>
<style>
  /* --- Базовый стиль (чисто и нейтрально) --- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(-45deg,#0f0c29,#302b63,#24243e);font-family:Inter,Arial, sans-serif;color:#fff}
  .app{width:920px;max-width:96%;padding:28px;border-radius:12px;background:rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6);position:relative}
  .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .title{font-weight:700;font-size:18px}
  .settings-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;cursor:pointer}
  .progress{margin-bottom:16px}
  .progress .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .bar{height:14px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden}
  .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff6b6b,#ff8e53);transition:width .45s}
  .steps{display:flex;gap:10px;margin-top:10px;justify-content:center}
  .dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.12)}
  .dot.done{background:linear-gradient(90deg,#8ceb8e,#2ecc71)}
  .dot.sus{background:#f4a261}
  .btn{display:inline-flex;align-items:center;gap:12px;padding:18px 48px;border-radius:60px;background:linear-gradient(45deg,#ff6b6b,#ff8e53);color:#fff;font-weight:700;text-transform:uppercase;cursor:pointer;border:none}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .status{margin-top:12px;color:rgba(255,255,255,0.85)}
  .debug{margin-top:14px;background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;font-size:13px;color:rgba(255,255,255,0.9);max-height:220px;overflow:auto}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
  .modal.open{display:flex}
  .card{width:760px;max-width:94%;background:#0f0c1a;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .field{display:flex;gap:10px;align-items:center;margin:8px 0}
  .field label{width:180px;color:rgba(255,255,255,0.9)}
  .field input[type=text], .field input[type=number], .field select{flex:1;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);color:#fff}
  .links-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .link-row{display:flex;gap:8px}
  .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .controls button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,#38bdf8,#7c3aed);color:#fff}
  .btn-danger{background:#ff6b6b;color:#fff}
  /* strict challenge UI */
  .challenge{margin-top:12px;display:flex;gap:12px;justify-content:center;align-items:center}
  .zone{width:120px;height:36px;border-radius:8px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center}
  .zone.active{box-shadow:0 6px 18px rgba(0,0,0,0.4);background:linear-gradient(90deg,#ffd166,#ef476f)}
  .slider-wrap{display:flex;gap:8px;align-items:center}
  .slider{width:220px;height:10px;background:rgba(255,255,255,0.06);border-radius:8px;position:relative}
  .thumb{position:absolute;top:-7px;left:0;width:24px;height:24px;border-radius:50%;background:#fff}
  .small{font-size:13px;color:rgba(255,255,255,0.7);margin-top:8px}
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="top-row">
      <div class="title">Free Key — Защита (клиент)</div>
      <button class="settings-btn" id="openSettings">⚙️ Настройки</button>
    </div>

    <div class="progress">
      <div class="meta"><div>Этап <span id="curStage">1</span> из <span id="totalStages">3</span></div><div id="stageFlag">Ожидание</div></div>
      <div class="bar"><i id="barFill"></i></div>
      <div class="steps" id="steps"></div>
    </div>

    <div style="text-align:center">
      <button class="btn" id="startBtn">Начать этап</button>
    </div>

    <div class="status" id="status">Статус: готов</div>

    <div class="challenge" id="challengeUI" style="display:none">
      <div class="zone" data-i="0">ЗОНА 1</div>
      <div class="zone" data-i="1">ЗОНА 2</div>
      <div class="zone" data-i="2">ЗОНА 3</div>
      <div class="slider-wrap" id="sliderWrap" style="display:none">
        <div class="slider" id="slider"><div class="thumb" id="thumb"></div></div>
      </div>
    </div>

    <div class="debug" id="debug">
      <div><b>Метрики</b></div>
      <pre id="debugPre" style="white-space:pre-wrap"></pre>
    </div>

    <div class="small">Подсказка: включай строгий режим в настройках, если хочешь усложнить обход.</div>
  </div>

  <!-- Settings modal -->
  <div class="modal" id="modal">
    <div class="card">
      <h3>Настройки защиты</h3>
      <div class="field">
        <label>Число этапов</label>
        <select id="cfgStages"><option>1</option><option selected>2</option><option>3</option></select>
      </div>

      <div id="linksBox" class="links-list"></div>

      <div class="field">
        <label>Мин. сек. на этап (через запятую)</label>
        <input type="text" id="cfgMinTimes" placeholder="5,7,8"/>
      </div>

      <div class="field">
        <label>Строгий режим</label>
        <select id="cfgStrict"><option value="0">Выкл</option><option value="1">Вкл</option></select>
      </div>

      <div class="field">
        <label>Ссылка при подозрении</label>
        <input type="text" id="cfgBypass" placeholder="https://example.com/get-key"/>
      </div>

      <div class="field">
        <label>Авто-редирект при подозрении</label>
        <select id="cfgAuto"><option value="1">Да</option><option value="0">Нет</option></select>
      </div>

      <div class="controls">
        <button id="resetBtn">Сброс</button>
        <button id="closeBtn">Закрыть</button>
        <button class="btn-primary" id="saveBtn">Сохранить</button>
      </div>
      <p class="small">Изменения сохраняются в браузере. Strict Mode требует выполнения мини-задания (труднее эмулировать).</p>
    </div>
  </div>

<script>
/* =========================
   Конфигурация / defaults
   ========================= */
const DEFAULT = {
  stages: 2,
  links: ["https://example.com/step1","https://example.com/step2","https://example.com/step3"],
  minTimes: [5,7,8],
  strictMode: false,
  bypassUrl: "https://example.com/get-key",
  autoBypass: true,
  storageKey: "adv_protect_cfg_v1"
};

/* Загружаем конфиг из localStorage или берем дефолт */
let CFG = {...DEFAULT};
try{
  const raw = localStorage.getItem(DEFAULT.storageKey);
  if(raw){
    const parsed = JSON.parse(raw);
    CFG = Object.assign(CFG, parsed);
    // ensure arrays sizes
    if(!Array.isArray(CFG.links)) CFG.links = DEFAULT.links.slice();
    if(!Array.isArray(CFG.minTimes)) CFG.minTimes = DEFAULT.minTimes.slice();
  }
}catch(e){ console.warn("cfg load err", e); }

/* =========================
   Runtime state
   ========================= */
const state = {
  cur: 0,
  inProgress: false,
  awaitingReturn: false,
  startTs: 0,
  mouse: [],
  clicks: 0,
  keys: 0,
  focusChanges: 0,
  visibilityChanges: 0,
  devtools: false,
  tamper: false,
  debuggerPaused: false,
  integrityFail: false,
  bypassShown: false,
  strictProgress: [false,false,false] // for zones
};

/* =========================
   UI refs
   ========================= */
const openSettings = document.getElementById('openSettings');
const modal = document.getElementById('modal');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');
const resetBtn = document.getElementById('resetBtn');
const cfgStages = document.getElementById('cfgStages');
const linksBox = document.getElementById('linksBox');
const cfgMinTimes = document.getElementById('cfgMinTimes');
const cfgStrict = document.getElementById('cfgStrict');
const cfgBypass = document.getElementById('cfgBypass');
const cfgAuto = document.getElementById('cfgAuto');

const curStageEl = document.getElementById('curStage');
const totalStagesEl = document.getElementById('totalStages');
const barFill = document.getElementById('barFill');
const stepsEl = document.getElementById('steps');
const startBtn = document.getElementById('startBtn');
const status = document.getElementById('status');
const stageFlag = document.getElementById('stageFlag');
const debugPre = document.getElementById('debugPre');
const challengeUI = document.getElementById('challengeUI');
const zoneEls = Array.from(document.querySelectorAll('.zone'));
const sliderWrap = document.getElementById('sliderWrap');
const slider = document.getElementById('slider');
const thumb = document.getElementById('thumb');

/* =========================
   Utility helpers
   ========================= */
function saveCfg(){ try{ localStorage.setItem(DEFAULT.storageKey, JSON.stringify(CFG)); }catch(e){} }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* =========================
   Init UI
   ========================= */
function buildLinksInputs(n){
  linksBox.innerHTML = "";
  for(let i=0;i<n;i++){
    const div = document.createElement('div'); div.className='link-row';
    const inp = document.createElement('input'); inp.type='text'; inp.value = CFG.links[i] || ""; inp.placeholder = "https://...";
    const time = document.createElement('input'); time.type='number'; time.min='1'; time.value = CFG.minTimes[i] || DEFAULT.minTimes[i] || 5;
    div.appendChild(inp); div.appendChild(time);
    linksBox.appendChild(div);
  }
}
function populateSettings(){
  cfgStages.value = String(CFG.stages);
  cfgMinTimes.value = (CFG.minTimes.slice(0,CFG.stages).join(','));
  cfgStrict.value = CFG.strictMode ? '1':'0';
  cfgBypass.value = CFG.bypassUrl;
  cfgAuto.value = CFG.autoBypass ? '1':'0';
  buildLinksInputs(CFG.stages);
}
function renderProgress(){
  totalStagesEl.textContent = CFG.stages;
  stepsEl.innerHTML = "";
  for(let i=0;i<CFG.stages;i++){
    const d = document.createElement('div'); d.className='dot'; if(i<state.cur) d.classList.add('done');
    stepsEl.appendChild(d);
  }
  curStageEl.textContent = Math.min(state.cur+1, CFG.stages);
  const pct = Math.round((state.cur / CFG.stages)*100);
  barFill.style.width = pct + '%';
}
populateSettings(); renderProgress();

/* =========================
   Integrity / checksum of functions & DOM snapshot
   ========================= */
const integrity = {
  funcs: {},
  domSnapshot: null,
  computeStrHash(s){
    let h=0; for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; } return h;
  },
  store(){
    // keep key functions stringified
    const names = ['onMouse','onClick','onKey','onWindowFocus','startStage','evaluateHuman'];
    names.forEach(n=>{
      try{ integrity.funcs[n] = integrity.computeStrHash(window[n].toString()); }catch(e){}
    });
    integrity.domSnapshot = document.getElementById('app').outerHTML.length;
  },
  check(){
    try{
      for(const k in integrity.funcs){
        if(!window[k]) return integrityFail('func_missing_'+k);
        const h = integrity.computeStrHash(window[k].toString());
        if(h !== integrity.funcs[k]) return integrityFail('func_changed_'+k);
      }
      const curLen = document.getElementById('app').outerHTML.length;
      if(Math.abs(curLen - integrity.domSnapshot) > 500) return integrityFail('dom_changed');
    }catch(e){ return integrityFail('check_error'); }
    return true;
  }
};
function integrityFail(reason){
  state.integrityFail = true;
  triggerBypass('integrity_fail_'+reason);
  return false;
}

/* =========================
   DevTools / Debugger detection
   ========================= */
(function detectDevtoolsAndDebug(){
  // window size heuristic
  setInterval(()=>{
    const wd = Math.abs(window.outerWidth - window.innerWidth);
    const hd = Math.abs(window.outerHeight - window.innerHeight);
    if(wd>160 || hd>160) state.devtools = true;
  },1200);

  // RAF pause detection (debugger pausing causes long gaps)
  let lastRaf = performance.now();
  function rafLoop(ts){
    if(ts - lastRaf > 250) state.debuggerPaused = true;
    lastRaf = ts;
    requestAnimationFrame(rafLoop);
  }
  requestAnimationFrame(rafLoop);

  // function getter trick
  try{
    const o={};
    Object.defineProperty(o,'x',{get(){ state.devtools = true; return true;}});
    console.log('%c', o);
  }catch(e){}
})();

/* =========================
   Event handlers & metrics
   ========================= */
function onMouse(e){ const t=Date.now(); state.mouse.push({x:e.clientX,y:e.clientY,t}); if(state.mouse.length>1000) state.mouse.shift(); }
function onClick(){ state.clicks++; }
function onKey(){ state.keys++; }
function onFocus(){ state.focusChanges++; }
function onVisibility(){ state.visibilityChanges++; }

function avgSpeed(){
  const a = state.mouse; if(a.length<2) return 0;
  let sum=0, c=0;
  for(let i=1;i<a.length;i++){ const dx=a[i].x-a[i-1].x, dy=a[i].y-a[i-1].y, dt = Math.max(1, a[i].t - a[i-1].t); sum += Math.hypot(dx,dy)/dt; c++; }
  return c?sum/c:0;
}
function uniquePositions(limit=100){
  const s = new Set(); const a = state.mouse.slice(-limit);
  a.forEach(p=> s.add(`${Math.round(p.x/20)}_${Math.round(p.y/20)}`));
  return s.size;
}

/* =========================
   Evaluation logic
   ========================= */
function evaluateHuman(timeMs){
  const timeSec = timeMs/1000;
  const mm = state.mouse.length;
  const clicks = state.clicks;
  const keys = state.keys;
  const speed = avgSpeed();
  const uniq = uniquePositions();
  let score=0;
  if(mm>12) score++;
  if(uniq>6) score++;
  if(clicks>0) score += 0.7;
  if(keys>0) score += 0.4;
  if(speed>0.02 && speed<3) score++;
  const minReq = (CFG.minTimes && CFG.minTimes[state.cur]) ? CFG.minTimes[state.cur] : DEFAULT.minTimes[state.cur] || 5;
  if(timeSec >= minReq) score += 1.2;
  if(state.devtools) score -= 5;
  if(state.debuggerPaused) score -= 8;
  if(state.integrityFail) score -= 10;
  return {score, mm, uniq, clicks, keys, speed, timeSec, minReq};
}

/* =========================
   Strict challenge: zones sequence OR slider
   ========================= */
let activeStrict = false;
function startStrictUI(){
  if(!CFG.strictMode) return;
  activeStrict = true;
  challengeUI.style.display = 'flex';
  sliderWrap.style.display = 'none';
  // reset progress
  state.strictProgress = [false,false,false];
  zoneEls.forEach(z=> z.classList.remove('active'));
  // attach mouse move check for zones — left to right order
  function zoneCheck(e){
    const r = zoneEls.map(z=>z.getBoundingClientRect());
    for(let i=0;i<r.length;i++){
      if(e.clientX >= r[i].left && e.clientX <= r[i].right && e.clientY >= r[i].top && e.clientY <= r[i].bottom){
        // require previous done
        if(i===0 || state.strictProgress[i-1]){
          state.strictProgress[i]=true; zoneEls[i].classList.add('active');
        }
      }
    }
    // check completion
    if(state.strictProgress.every(Boolean)){
      // detach
      window.removeEventListener('mousemove', zoneCheck);
      activeStrict = false;
      challengeUI.style.display = 'none';
      passStrict();
    }
  }
  window.addEventListener('mousemove', zoneCheck, {passive:true});
}
function passStrict(){ /* simply mark stage as ok (called when strict passed) */
  state.strictPassed = true;
  status.textContent = 'Strict challenge пройден';
}

/* Slider variant (not used by default, kept for extensibility) */
let draggingThumb = false;
thumb.style.left = '0px';
thumb.addEventListener('pointerdown', (e)=>{ draggingThumb=true; thumb.setPointerCapture(e.pointerId); });
window.addEventListener('pointermove', (e)=>{
  if(!draggingThumb) return;
  const rect = slider.getBoundingClientRect();
  let x = clamp(e.clientX - rect.left - (thumb.offsetWidth/2), 0, rect.width - thumb.offsetWidth);
  thumb.style.left = x + 'px';
  // progress check
  if(x >= rect.width - thumb.offsetWidth - 4){
    draggingThumb = false;
    status.textContent = 'Слайдер пройден';
    sliderWrap.style.display = 'none';
    challengeUI.style.display = 'none';
    state.strictPassed = true;
  }
});
window.addEventListener('pointerup', ()=>{ draggingThumb=false; });

/* =========================
   Start/finish stage behavior
   ========================= */
function startStage(){
  if(state.inProgress || state.awaitingReturn) return;
  if(state.cur >= CFG.stages){ status.textContent = 'Все этапы завершены'; return; }

  // integrity store first-run
  integrity.store();

  state.inProgress = true;
  state.awaitingReturn = true;
  state.startTs = Date.now();
  state.mouse = []; state.clicks=0; state.keys=0; state.focusChanges=0; state.visibilityChanges=0;
  state.strictPassed = false; state.integrityFail = false;

  status.textContent = `Этап ${state.cur+1} запущен — откройте ссылку в новой вкладке`;
  stageFlag.textContent = `Этап ${state.cur+1}: открыт ресурс`;

  // optionally start strict challenge UI
  if(CFG.strictMode) startStrictUI();

  // open link
  const url = CFG.links[state.cur] || '#';
  window.open(url, '_blank', 'noopener,noreferrer');
}

/* when user returns (focus) */
async function onWindowFocus(){
  if(!state.awaitingReturn){ state.focusChanges++; return; }
  const now = Date.now(); const elapsed = now - state.startTs;
  // first, integrity check
  integrity.check();

  // compute analysis
  const res = evaluateHuman(elapsed);
  // if strict required and not passed — consider suspicious
  if(CFG.strictMode && !state.strictPassed) res.score -= 5;

  // decide threshold
  const passed = res.score >= 2.5 && !state.devtools && !state.debuggerPaused && !state.integrityFail;

  if(passed){
    // mark step done
    const dot = stepsEl.children[state.cur];
    if(dot) dot.classList.add('done');
    state.cur++;
    saveCfg();
    status.textContent = `Этап ${state.cur} пройден честно (${Math.round(elapsed/1000)} с)`;
    stageFlag.textContent = `Этап ${state.cur}: пройден`;
    startBtn.textContent = state.cur >= CFG.stages ? 'Завершено' : 'Начать этап';
  } else {
    const dot = stepsEl.children[state.cur];
    if(dot) dot.classList.add('sus');
    status.innerHTML = `<span style="color:#ff6b6b;font-weight:700">Подозрение на обход</span> — ${Math.round(elapsed/1000)} с`;
    stageFlag.textContent = `Этап ${state.cur+1}: подозрение`;
    startBtn.textContent = 'Повторить этап';
    // trigger bypass UI
    triggerBypass(`susp_score_${(res.score||0).toFixed(2)}`);
  }

  // update debug
  debugPre.textContent = JSON.stringify({res, devtools:state.devtools, debugPaused:state.debuggerPaused, integrityFail:state.integrityFail}, null, 2);

  state.inProgress=false;
  state.awaitingReturn=false;
  renderProgress();
}

/* =========================
   Bypass / Warning page logic (data-URL)
   ========================= */
function triggerBypass(reason){
  if(state.bypassShown) return;
  state.bypassShown = true;
  // prepare page with reason and link
  const reasonEnc = encodeURIComponent(reason);
  const linkEnc = encodeURIComponent(CFG.bypassUrl || DEFAULT.bypassUrl);
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Подозрение на обход</title>
    <style>body{font-family:Arial, sans-serif;background:#0f0c1a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
      .box{max-width:720px;padding:28px;border-radius:12px;background:rgba(255,255,255,0.03);text-align:center}
      .btn{display:inline-block;padding:12px 18px;border-radius:10px;background:linear-gradient(90deg,#38bdf8,#7c3aed);color:#fff;text-decoration:none;margin-top:14px}
      .close{display:inline-block;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff;margin-left:8px}
    </style></head><body><div class="box">
    <h1>Внимание</h1>
    <p>Обнаружено подозрительное поведение: <b>${decodeURIComponent(reasonEnc)}</b></p>
    <p>Если вы не пытались обойти систему и хотите получить ключ — нажмите «Получить ключ».</p>
    <a class="btn" href="${decodeURIComponent(linkEnc)}" target="_blank" rel="noopener">Получить ключ</a>
    <button class="close" onclick="window.close()">Закрыть</button>
    </div></body></html>
  `.trim();
  const data = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
  if(CFG.autoBypass) window.open(data,'_blank','noopener'); else window.open(data,'_blank','noopener');
  // lock UI
  startBtn.setAttribute('disabled','');
  startBtn.textContent = 'Заблокировано';
}

/* =========================
   Periodic integrity/checks & tamper detection
   ========================= */
(function periodicChecks(){
  // store initial prototypes to detect overrides
  const protoHashes = {
    addEventListener: Function.prototype.addEventListener.toString().length,
    fetch: window.fetch ? window.fetch.toString().length : 0
  };
  integrity.store();
  setInterval(()=>{
    // check prototypes
    try{
      if(Function.prototype.addEventListener.toString().length !== protoHashes.addEventListener) state.tamper = true;
      if(window.fetch && window.fetch.toString().length !== protoHashes.fetch) state.tamper = true;
    }catch(e){}
    // integrity
    integrity.check();
    // if tamper/integrity fail -> trigger bypass
    if(state.tamper || state.integrityFail) triggerBypass('tamper_or_integrity');
    // self-heal: if UI removed -> reload
    if(!document.getElementById('app')) location.reload();
  }, 900);
})();

/* =========================
   Attach events
   ========================= */
window.addEventListener('mousemove', onMouse, {passive:true});
window.addEventListener('mousedown', onClick);
window.addEventListener('keydown', onKey);
window.addEventListener('focus', onWindowFocus);
window.addEventListener('visibilitychange', onVisibility);

startBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  startStage();
});

/* settings UI actions */
openSettings.addEventListener('click', ()=>{ populateSettings(); modal.classList.add('open'); });
closeBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); });
resetBtn.addEventListener('click', ()=>{ if(confirm('Сбросить настройки к дефолту?')){ CFG={...DEFAULT}; saveCfg(); populateSettings(); renderProgress(); modal.classList.remove('open'); }});

saveBtn.addEventListener('click', ()=>{
  try{
    const n = clamp(parseInt(cfgStages.value,10)||2,1,3);
    CFG.stages = n;
    // read links/time rows
    const rows = Array.from(linksBox.querySelectorAll('.link-row'));
    const links = []; const times = [];
    if(rows.length === 0) buildLinksInputs(n);
    const inputs = linksBox.querySelectorAll('input');
    for(let i=0;i<n;i++){
      const link = inputs[i*2] ? inputs[i*2].value.trim() : (DEFAULT.links[i]||'#');
      const t = parseInt(inputs[i*2+1].value,10) || (DEFAULT.minTimes[i] || 5);
      links.push(link || '#'); times.push(Math.max(1,t));
    }
    CFG.links = links;
    CFG.minTimes = times;
    CFG.minTimes = CFG.minTimes.slice(0,CFG.stages);
    // other simple fields
    CFG.strictMode = cfgStrict.value === '1';
    CFG.bypassUrl = cfgBypass.value.trim() || DEFAULT.bypassUrl;
    CFG.autoBypass = cfgAuto.value === '1';
    saveCfg();
    modal.classList.remove('open');
    renderProgress();
    status.textContent = 'Настройки сохранены';
  }catch(err){
    console.error(err); alert('Ошибка сохранения настроек');
  }
});

/* initial populate (links inputs depend on config) */
buildLinksInputs(CFG.stages);

/* debug refresh */
setInterval(()=> {
  debugPre.textContent = JSON.stringify({
    cur: state.cur,
    inProgress: state.inProgress,
    devtools: state.devtools,
    debuggerPaused: state.debuggerPaused,
    tamper: state.tamper,
    integrityFail: state.integrityFail,
    metrics: {mouse: state.mouse.length, clicks: state.clicks, keys: state.keys}
  }, null, 2);
}, 700);

</script>
</body>
</html>
