<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Free Key Generator — настройки этапов</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:Arial, sans-serif;background:linear-gradient(-45deg,#0f0c29,#302b63,#24243e);color:#fff;overflow:hidden}
  .card{width:900px;max-width:96%;padding:28px;border-radius:14px;background:rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.6);position:relative;text-align:center}
  /* settings button */
  .settings-btn{position:fixed;right:18px;top:18px;z-index:50;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);padding:8px 12px;border-radius:10px;cursor:pointer;backdrop-filter:blur(8px);color:#fff}
  .settings-btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.3)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:100}
  .modal.open{display:flex}
  .modal-card{width:720px;max-width:94%;background:#0e0b1a;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(0,0,0,0.6);color:#fff}
  .modal-card h3{margin-bottom:8px}
  .field{margin:8px 0;display:flex;gap:10px;align-items:center}
  .field label{width:150px;font-size:14px;color:rgba(255,255,255,0.85)}
  .field input[type="text"], .field input[type="number"], .field select{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff}
  .field small{display:block;color:rgba(255,255,255,0.6);font-size:12px;margin-top:4px}
  .links-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
  .link-row{display:flex;gap:8px}
  .link-row input{flex:1}
  .btn-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .btn{padding:8px 14px;border-radius:10px;border:none;cursor:pointer}
  .btn.save{background:linear-gradient(90deg,#38bdf8,#7c3aed);color:#fff}
  .btn.reset{background:rgba(255,255,255,0.06);color:#fff}
  .btn.close{background:#ff6b6b;color:#fff}
  /* progress and UI (from previous) */
  .progress-wrap{margin-bottom:18px;text-align:left}
  .progress-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .stage-label{font-weight:700}
  .progress-bar{width:100%;height:14px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;position:relative}
  .progress-bar>.fill{height:100%;width:0%;background:linear-gradient(90deg,#ff6b6b,#ff8e53);transition:width .45s ease}
  .steps-row{display:flex;gap:10px;margin-top:10px;justify-content:center}
  .step-dot{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.12)}
  .step-dot.done{background:linear-gradient(90deg,#8ceb8e,#2ecc71)}
  .step-dot.sus{background:#f4a261}
  .main-btn{padding:20px 56px;border-radius:60px;background:linear-gradient(45deg,#ff6b6b,#ff8e53);color:white;font-weight:700;text-transform:uppercase;display:inline-flex;align-items:center;gap:12px;cursor:pointer;user-select:none;box-shadow:0 10px 30px rgba(255,107,107,0.35);transition:transform .35s, box-shadow .35s}
  .main-btn:hover{transform:translateY(-6px) scale(1.03)}
  .main-btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}
  .status{margin-top:12px;font-size:14px;color:rgba(255,255,255,0.85)}
  .metrics{margin-top:14px;text-align:left;font-size:13px;color:rgba(255,255,255,0.85);background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;max-height:200px;overflow:auto}
  .small{font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px}
</style>
</head>
<body>
  <button class="settings-btn" id="openSettings">⚙️ Настройки</button>

  <div class="modal" id="modal">
    <div class="modal-card" role="dialog" aria-modal="true">
      <h3>Настройки этапов</h3>
      <div class="field">
        <label for="totalStages">Число этапов</label>
        <select id="totalStagesSelect">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>

      <div id="linksContainer" class="links-list"></div>

      <div class="field">
        <label for="saveLocal">Сохранить локально</label>
        <select id="saveLocal">
          <option value="1">Да</option>
          <option value="0">Нет</option>
        </select>
      </div>

      <div class="btn-row">
        <button class="btn reset" id="resetDefaults">Сбросить по умолчанию</button>
        <button class="btn close" id="closeModal">Закрыть</button>
        <button class="btn save" id="saveSettingsBtn">Сохранить</button>
      </div>
      <p class="small">Ссылки откроются в новой вкладке при старте этапа. Все настройки сохраняются в браузере (localStorage) если включено.</p>
    </div>
  </div>

  <div class="card" id="app">
    <div class="progress-wrap">
      <div class="progress-top">
        <div class="stage-label">Этап <span id="curStage">1</span> из <span id="totalStagesDisplay">3</span></div>
        <div id="stageStateLabel">Ожидание</div>
      </div>
      <div class="progress-bar" aria-hidden="true">
        <div class="fill" id="progressFill"></div>
      </div>
      <div class="steps-row" id="stepsRow"></div>
    </div>

    <a id="mainButton" class="main-btn" role="button" href="#" target="_blank" rel="noopener">
      <span id="btnText">Начать этап</span>
    </a>

    <div class="status" id="status">Статус: не начинали</div>

    <div class="metrics" id="metricsBox">
      <div><b>Метрики (локально)</b></div>
      <pre id="metricsContent" style="white-space:pre-wrap"></pre>
    </div>

    <div class="small">Замечание: клиентские проверки усложняют обход, но полностью предотвратить байпас без сервера нельзя.</div>
  </div>

<script>
/* ---------- Defaults ---------- */
const DEFAULT_CONFIG = {
  totalStages: 3,
  links: ["https://example.com/step1", "https://example.com/step2", "https://example.com/step3"],
  minSecondsPerStage: [5,7,8],
  saveToLocal: true,
  localKey: "fkgen_config_v2"
};

/* ---------- Runtime config (mutable) ---------- */
let CONFIG = { ...DEFAULT_CONFIG };

/* ---------- State ---------- */
const state = {
  curStage: 0,
  inProgress: false,
  awaitingReturn: false,
  stageStartTs: null,
  mouseMoves: [],
  clicks: 0, keys: 0, touch: 0, focusChanges: 0, visibilityChanges: 0,
  devtoolsDetected: false, tamperDetected: false, debuggerPaused: false
};

/* ---------- UI refs ---------- */
const openSettingsBtn = document.getElementById('openSettings');
const modal = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModal');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const resetDefaultsBtn = document.getElementById('resetDefaults');
const totalStagesSelect = document.getElementById('totalStagesSelect');
const linksContainer = document.getElementById('linksContainer');
const saveLocalSelect = document.getElementById('saveLocal');

const curStageEl = document.getElementById("curStage");
const totalStagesDisplay = document.getElementById("totalStagesDisplay");
const progressFill = document.getElementById("progressFill");
const stepsRow = document.getElementById("stepsRow");
const btn = document.getElementById("mainButton");
const btnText = document.getElementById("btnText");
const statusEl = document.getElementById("status");
const stageStateLabel = document.getElementById("stageStateLabel");
const metricsContent = document.getElementById("metricsContent");

/* ---------- Storage helpers ---------- */
function loadConfigFromStorage(){
  try {
    const raw = localStorage.getItem(DEFAULT_CONFIG.localKey);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    // basic validation
    if (typeof parsed.totalStages === 'number' && Array.isArray(parsed.links)) {
      CONFIG = { ...DEFAULT_CONFIG, ...parsed };
      return true;
    }
  } catch(e){}
  return false;
}
function saveConfigToStorage(){
  if (!CONFIG.saveToLocal) { localStorage.removeItem(DEFAULT_CONFIG.localKey); return; }
  try {
    localStorage.setItem(DEFAULT_CONFIG.localKey, JSON.stringify(CONFIG));
  } catch(e){}
}

/* ---------- Settings UI ---------- */
function openSettings(){
  populateSettingsForm();
  modal.classList.add('open');
}
function closeSettings(){
  modal.classList.remove('open');
}
function populateSettingsForm(){
  totalStagesSelect.value = String(CONFIG.totalStages || 1);
  saveLocalSelect.value = CONFIG.saveToLocal ? "1" : "0";
  renderLinkInputs(CONFIG.totalStages);
}
function renderLinkInputs(n){
  linksContainer.innerHTML = "";
  for (let i=0;i<n;i++){
    const div = document.createElement('div');
    div.className = 'link-row';
    const linkInput = document.createElement('input');
    linkInput.type = 'text';
    linkInput.placeholder = `Ссылка для этапа ${i+1}`;
    linkInput.value = CONFIG.links[i] || "";
    linkInput.dataset.index = i;
    const timeInput = document.createElement('input');
    timeInput.type = 'number';
    timeInput.min = '1';
    timeInput.style.width = '110px';
    timeInput.value = CONFIG.minSecondsPerStage[i] || DEFAULT_CONFIG.minSecondsPerStage[i] || 5;
    timeInput.title = 'Мин. время в сек.';
    timeInput.dataset.index = i;
    div.appendChild(linkInput);
    div.appendChild(timeInput);
    linksContainer.appendChild(div);
  }
}

/* ---------- Apply settings ---------- */
function saveSettingsFromForm(){
  const n = parseInt(totalStagesSelect.value,10);
  CONFIG.totalStages = Math.max(1, Math.min(3, n));
  CONFIG.links = [];
  CONFIG.minSecondsPerStage = [];
  const rows = linksContainer.querySelectorAll('.link-row');
  rows.forEach((row, idx)=>{
    const link = row.querySelector('input[type="text"]').value.trim();
    const t = parseInt(row.querySelector('input[type="number"]').value,10) || DEFAULT_CONFIG.minSecondsPerStage[idx] || 5;
    CONFIG.links.push(link || ("#"));
    CONFIG.minSecondsPerStage.push(Math.max(1, t));
  });
  CONFIG.saveToLocal = saveLocalSelect.value === "1";
  saveConfigToStorage();
  // if current stage greater than new total — clamp
  if (state.curStage >= CONFIG.totalStages) state.curStage = Math.max(0, CONFIG.totalStages-1);
  renderSteps();
  closeSettings();
}

/* ---------- Reset to defaults ---------- */
function resetDefaults(){
  CONFIG = { ...DEFAULT_CONFIG };
  saveConfigToStorage();
  state.curStage = 0;
  renderSteps();
  closeSettings();
}

/* ---------- Progress UI ---------- */
function renderSteps(){
  totalStagesDisplay.textContent = CONFIG.totalStages;
  stepsRow.innerHTML = "";
  for (let i=0;i<CONFIG.totalStages;i++){
    const dot = document.createElement('span');
    dot.className = 'step-dot';
    if (i < state.curStage) dot.classList.add('done');
    stepsRow.appendChild(dot);
  }
  updateProgress();
}
function updateProgress(){
  const percent = Math.round((state.curStage / CONFIG.totalStages) * 100);
  progressFill.style.width = percent + "%";
  curStageEl.textContent = Math.min(state.curStage+1, CONFIG.totalStages);
}

/* ---------- Interaction & metrics (same as before, kept lightweight) ---------- */
function onMouseMove(e){ const t=Date.now(); state.mouseMoves.push({x:e.clientX,y:e.clientY,t}); if (state.mouseMoves.length>600) state.mouseMoves.shift(); }
function onClick(){ state.clicks++; }
function onKey(){ state.keys++; }
function onTouch(){ state.touch++; }
function onFocus(){ state.focusChanges++; }
function onVisibility(){ state.visibilityChanges++; }

function computeAvgMouseSpeed(){
  const arr = state.mouseMoves;
  if (arr.length<2) return 0;
  let total=0, count=0;
  for (let i=1;i<arr.length;i++){
    const dx=arr[i].x-arr[i-1].x, dy=arr[i].y-arr[i-1].y;
    const dt=Math.max(1, arr[i].t - arr[i-1].t);
    total += Math.hypot(dx,dy)/dt; count++;
  }
  return count ? (total/count) : 0;
}
function countUniquePositions(limit){
  const s=new Set(); const arr=state.mouseMoves.slice(-limit);
  arr.forEach(p=>s.add(`${Math.round(p.x/10)}_${Math.round(p.y/10)}`));
  return s.size;
}
function analyzeBehavior(timeMs){
  const timeSec = timeMs/1000;
  const mm = state.mouseMoves.length;
  const clicks = state.clicks;
  const keys = state.keys;
  const avgSpeed = computeAvgMouseSpeed();
  const webdriver = !!navigator.webdriver;
  const uniquePositions = countUniquePositions(100);
  const minReq = CONFIG.minSecondsPerStage[state.curStage] || 5;
  let score = 0;
  if (mm>12) score+=1;
  if (uniquePositions>8) score+=1;
  if (clicks>0) score+=0.8;
  if (keys>0) score+=0.5;
  if (avgSpeed>0.02 && avgSpeed<3) score+=1;
  if (timeSec>=minReq) score+=1.2;
  if (state.devtoolsDetected) score-=5;
  if (state.tamperDetected) score-=10;
  if (state.debuggerPaused) score-=8;
  if (webdriver) score-=10;
  return {score, mm, uniquePositions, clicks, keys, avgSpeed, timeSec, minReq, webdriver};
}

/* ---------- Simple anti-tamper & devtools detection ---------- */
(function devtoolsAndDebuggerDetection(){
  setInterval(()=>{ const wdiff=Math.abs(window.outerWidth-window.innerWidth); const hdiff=Math.abs(window.outerHeight-window.innerHeight); if (wdiff>160 || hdiff>160) state.devtoolsDetected=true; },1000);
  let last=performance.now();
  setInterval(()=>{ const now=performance.now(); if (now-last>200) state.debuggerPaused=true; last=now; },100);
  try { const dev={}; Object.defineProperty(dev,'x',{get(){ state.devtoolsDetected=true; return true; }}); console.log('%c', dev); } catch(e){}
})();

const mo = new MutationObserver((mut)=>{
  for(const m of mut){
    if (m.target && (m.target.id==='mainButton' || m.target.closest && m.target.closest('#app')===document.getElementById('app'))){
      if (document.getElementById('mainButton') && document.getElementById('mainButton').innerHTML.indexOf('Начать этап')===-1) state.tamperDetected=true;
    }
  }
});
mo.observe(document.getElementById('app'), {attributes:true,childList:true,subtree:true});

/* ---------- Stage handling (open link, wait return on focus) ---------- */
function startStage(){
  if (state.inProgress || state.awaitingReturn) return;
  if (state.curStage >= CONFIG.totalStages){ statusEl.textContent = "Все этапы завершены"; return; }
  state.inProgress=true; state.awaitingReturn=true; state.stageStartTs=Date.now();
  state.mouseMoves=[]; state.clicks=0; state.keys=0; state.touch=0; state.focusChanges=0; state.visibilityChanges=0;
  stageStateLabel.textContent = `Этап ${state.curStage+1}: открыт внешний ресурс`;
  statusEl.textContent = "Открылось окно этапа — вернись на вкладку и дождись оценки";
  btnText.textContent = "Этап начат...";
  const url = CONFIG.links[state.curStage] || "#";
  window.open(url, "_blank", "noopener,noreferrer");
}

function onWindowFocus(){
  if (!state.awaitingReturn) { state.focusChanges++; return; }
  const now = Date.now();
  const timeSpent = now - state.stageStartTs;
  const analysis = analyzeBehavior(timeSpent);
  const passed = (analysis.score >= 2.5) && !analysis.webdriver && !state.tamperDetected && !state.devtoolsDetected && !state.debuggerPaused && analysis.timeSec >= analysis.minReq;

  if (passed){
    const dot = stepsRow.children[state.curStage]; if (dot) dot.classList.add('done');
    state.curStage++;
    saveConfigToStorage();
    statusEl.textContent = `Этап пройден честно — ${Math.round(timeSpent/1000)} с.`;
    stageStateLabel.textContent = `Этап ${Math.min(state.curStage, CONFIG.totalStages)}: пройден`;
    btnText.textContent = state.curStage >= CONFIG.totalStages ? "Завершено" : "Начать этап";
  } else {
    const dot = stepsRow.children[state.curStage]; if (dot) dot.classList.add('sus');
    statusEl.innerHTML = `<span style="color:#ff6b6b;font-weight:700">Подозрение на обход или неподходящее поведение.</span> ${Math.round(timeSpent/1000)} с. Повторите попытку.`;
    stageStateLabel.textContent = `Этап ${state.curStage+1}: подозрительный`;
    btnText.textContent = "Повторить этап";
  }

  metricsContent.textContent = JSON.stringify({analysis, devtools:state.devtoolsDetected, tamper:state.tamperDetected, debuggerPaused:state.debuggerPaused}, null, 2);

  state.inProgress=false; state.awaitingReturn=false;
  updateProgress();
}

/* ---------- init ---------- */
function init(){
  loadConfigFromStorage();
  renderSteps();
  // attach events
  openSettingsBtn.addEventListener('click', openSettings);
  closeModalBtn.addEventListener('click', closeSettings);
  saveSettingsBtn.addEventListener('click', saveSettingsFromForm);
  resetDefaultsBtn.addEventListener('click', ()=>{ if(confirm('Сбросить настройки к значениям по умолчанию?')) resetDefaults(); });
  totalStagesSelect.addEventListener('change', ()=> renderLinkInputs(parseInt(totalStagesSelect.value,10)));
  // page events
  btn.addEventListener('click', (e)=>{ e.preventDefault(); startStage(); });
  window.addEventListener('mousemove', onMouseMove, {passive:true});
  window.addEventListener('mousedown', onClick);
  window.addEventListener('keydown', onKey);
  window.addEventListener('touchstart', onTouch, {passive:true});
  window.addEventListener('focus', onWindowFocus);
  window.addEventListener('blur', onFocus);
  document.addEventListener('visibilitychange', onVisibility);

  // refresh metrics block
  setInterval(()=> {
    metricsContent.textContent = JSON.stringify({
      stage: state.curStage+1,
      mouseMoves: state.mouseMoves.length,
      clicks: state.clicks,
      keys: state.keys,
      focusChanges: state.focusChanges,
      visibilityChanges: state.visibilityChanges,
      devtools: state.devtoolsDetected,
      tamper: state.tamperDetected,
      debuggerPaused: state.debuggerPaused
    }, null, 2);
  }, 700);
}
init();
</script>
</body>
</html>
